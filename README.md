# Решение задачи динамического программирования

## Ф.И.О., группа, поток

Клименков Владислав Максимович, K3341, МЕТОПТ 1.2

## Предобработка условий задачи

Проведём определённую предобработку некоторых условий задачи, чтобы упростить дальнейшую формулировку самой задачи.

### Расчёт стоимости пакетов для покупки/продажи активов

В задании сказано, что покупать и продавать активы можно только пакетами, стоимость которых равна 25% от изначальной стоимости актива. Рассчитаем стоимость одного пакета для каждого актива:

- `ЦБ1: 100 * 25% = 25 (д.е.)`
- `ЦБ2: 800 * 25% = 200 (д.е.)`
- `Деп.: 400 * 25% = 100 (д.е.)`

В дальнейшем будем использовать уже рассчитанные значения стоимости пакетов.

### Переход от вероятностных сценариев к ожидаемому изменению стоимости активов

Для каждого этапа для всех трёх активов заданы сценарии с вероятностью их наступления и коэффициентом изменения стоимости актива при реализации данного сценария:

**Этап №1:**

| Ситуация | Вероят. | ЦБ1 | ЦБ2 | Деп. |
|--|--|--|--|--|
| Благопр. | 0.60 | 1.20 | 1.10 | 1.07 |
| Нейтр. | 0.30 | 1.05 | 1.02 | 1.03 |
| Негатив. | 0.10 | 0.80 | 0.95 | 1.00 |

**Этап №2:**

| Ситуация | Вероят. | ЦБ1 | ЦБ2 | Деп. |
|--|--|--|--|--|
| Благопр. | 0.30 | 1.4 | 1.15 | 1.01 |
| Нейтр. | 0.20 | 1.05 | 1.00 | 1.00 |
| Негатив. | 0.50 | 0.60 | 0.90 | 1.00 |

**Этап №3:**

| Ситуация | Вероят. | ЦБ1 | ЦБ2 | Деп. |
|--|--|--|--|--|
| Благопр. | 0.40 | 1.15 | 1.12 | 1.05 |
| Нейтр. | 0.40 | 1.05 | 1.01 | 1.01 |
| Негатив. | 0.20 | 0.70 | 0.94 | 1.00 |

Чтобы упростить задачу, уйдём от вероятностей, перейдя к ожидаемому изменению стоимости для каждого актива (т.е. объединим три сценария и их вероятности в одно значение ожидаемого изменения стоимости актива, тем самым перейдя от вероятностного события к детерминированному событию). Для этого воспользуемся формулой математического ожидания, которая имеет следующий вид:

`E(X) = Σ [x_i * p_i]`

где:

- `x_i` - возможные значения случайной величины,
- `p_i` - их вероятности.

Используя эту формулу, рассчитаем для каждого этапа ожидаемые значения изменения стоимости для каждого актива:

**Этап №1:**

- `ЦБ1: (0,60 * 1,20) + (0,30 * 1,05) + (0,10 * 0,80) = 1,115`
- `ЦБ2: (0,60 * 1,10) + (0,30 * 1,02) + (0,10 * 0,95) = 1,061`
- `Деп.: (0,60 * 1,07) + (0,30 * 1,03) + (0,10 * 1,00) = 1,051`

**Этап №2:**

- `ЦБ1: (0,30 * 1,40) + (0,20 * 1,05) + (0,50 * 0,60) = 0,93`
- `ЦБ2: (0,30 * 1,15) + (0,20 * 1,00) + (0,50 * 0,90) = 0,995`
- `Деп.: (0,30 * 1,01) + (0,20 * 1,00) + (0,50 * 1,00) = 1,003`

**Этап №3:**

- `ЦБ1: (0,40 * 1,15) + (0,40 * 1,05) + (0,20 * 0,70) = 1,02`
- `ЦБ2: (0,40 * 1,12) + (0,40 * 1,01) + (0,20 * 0,94) = 1,04`
- `Деп.: (0,40 * 1,05) + (0,40 * 1,01) + (0,20 * 1,00) = 1,024`

Запишем полученные результаты в виде таблицы:

| Этап | ЦБ1 | ЦБ2 | Деп. |
|--|--|--|--|
| 1 | 1,115 | 1,061 | 1,051 |
| 2 | 0,93 | 0,995 | 1,003 |
| 3 | 1,02 | 1,04 | 1,024 |

В дальнейшем вместо вероятностных сценариев будем использовать рассчитанные выше коэффициенты ожидаемого изменения цены активов.

## Свободная формулировка задачи

У нас есть инвестиционный портфель, которым мы будем управлять на протяжении трёх этапов `k = 1`, `k = 2` и `k = 3`, где `k = 1` - первый этап, а `k = 3` - последний этап.

На начало каждого этапа нам известно состояние инвестиционного портфеля `S_k`. Сам портфель может содержать четыре актива:

- Ценная бумага 1 (ЦБ1)
- Ценная бумага 2 (ЦБ2)
- Депозиты (Деп.)
- Свободные денежные средства (СДС)

Стоимость активов измеряется в денежных единицах (д.е.).

Изначально в инвестиционном портфеле следующее распределение активов:

- `ЦБ1 = 100 д.е.`
- `ЦБ2 = 800 д.е.`
- `Деп. = 400 д.е.`
- `СДС = 600 д.е.`

Состояние `S_k` задаётся вектором из четырёх чисел, соответствующих стоимости активов в портфеле по принципу `S_k = (<стоимость ЦБ1>, <стоимость ЦБ2>, <стоимость Деп.>, <стоимость СДС>)`.  Соответственно, для первого этапа мы имеем `S_1 = (100, 800, 400, 600)`.

Также на каждом этапе мы можем совершить операцию `x_k` по разбалансировке (покупке и продаже) активов. Покупать и продавать активы можно только пакетами (лотами). Вот размеры пакетов для каждого актива:

-  `1 пакет ЦБ1 = 25 д.е.`
-  `1 пакет ЦБ2 = 200 д.е.`
-  `1 пакет Деп. = 100 д.е.`

Для каждого этапа операция записывается в формате вектора из трёх чисел, где каждое число соответствует числу покупаемых или продаваемых пакетов активов `x_k = (<количество купленных/проданных пакетов ЦБ1>, <количество купленных/проданных пакетов ЦБ2>, <количество купленных/проданных пакетов Деп.>)`. Например, если на первом этапе мы хотим купить два пакета ЦБ1 (на 50 д.е.) и продать один пакет Деп. (100 д.е.), не трогая ЦБ2, то это можно записать как `x_1 = (2, 0, -1)`.

Также нужно учитывать, что по условиям задачи за каждую операцию берётся комиссия. Вот какие комиссии для операций с активами:

-  `ЦБ1: 4%`
-  `ЦБ2: 7%`
-  `Деп.: 5%`

То есть, например, при покупке или продаже одного пакета Деп. стоимостью 100 д.е. придётся заплатить комиссию в 5%, в данном случае равную 5 д.е.

Все покупки активов и комиссии по операциям оплачиваются из СДС. Например, при покупке `n` пакетов актива со стоимостью пакета `C` и комиссией `p` суммарные затраты из СДС составят `n * C * (1 + p)`. При продаже `n` пакетов в СДС поступает `n * C * (1 - p)`.

После совершения операций наступает событие `w_k` этапа, в рамках которого стоимость каждого актива изменяется в соответствии со следующей таблицей, где для всех активов и этапов указаны коэффициенты, на которые домножается стоимость активов в портфеле в рамках события на данном этапе:

| Этап | ЦБ1 | ЦБ2 | Деп. |
|--|--|--|--|
| 1 | 1.115 | 1.061 | 1.051 |
| 2 | 0.93 | 0.995 | 1.003 |
| 3 | 1.02 | 1.04 | 1.024 |

То есть, например, в рамках события на втором этапе стоимость ЦБ1 домножается на 0.93 (т.е. происходит снижение стоимости данного актива). А в рамках события на втором этапе стоимость Деп. домножается на 1.024 (т.е. происходит рост стоимости данного актива). В целом, событие этапа можно записать в виде вектора из трёх чисел `w_k = (<Коэффициент изменения стоимости ЦБ1>, <Коэффициент изменения стоимости ЦБ2>, <Коэффициент изменения стоимости Деп.>)`. Например, для события первого этапа имеем `w_1 = (1.115, 1.061, 1.051)`. При этом, событие `w_k` не влияет на СДС (в рамках события стоимость СДС остаётся постоянной).

В результате мы получаем следующую последовательность:

`S_k -> x_k -> w_k -> S_{k+1}`

То есть сначала мы смотрим состояние на данном этапе, потом совершаем операции на данном этапе, потом происходит событие на данном этапе, после чего мы смотрим состояние уже на следующем этапе.

Также по заданию существуют ограничения, которые задают минимальную стоимость каждого актива в портфеле:

- `ЦБ1: Не менее 30 д.е.`
- `ЦБ2: Не менее 150 д.е.`
- `Деп.: Не менее 100 д.е.`
- `СДС: Не менее 0 д.е.` (СДС не может быть отрицательным)

То есть, например, в любой момент стоимость ЦБ2 в портфеле не может опускаться ниже 150 д.е. (нельзя продать, чтобы стоимость стала меньше, и нельзя допустить, чтобы в рамках события стоимость ЦБ2 опустилась ниже данного значения). Аналогично и для других активов.

Требуется разработать такой план управления покупками/продажами активов на этапах `k = 1, 2, 3`, чтобы максимизировать общую стоимость инвестиционного портфеля в конце третьего этапа (`S_4`).

## Общая математическая формулировка задачи динамического программирования

В рамках задачи рассматриваются три этапа `k = 1, 2, 3` управления инвестиционным портфелем, который содержит следующие активы (в скобках указаны индексы данных активов, согласно которым они будут располагаться в рамках массивов и векторов):

- ЦБ1 (`i = 1`),
- ЦБ2: (`i = 2`),
- Деп.: (`i = 3`),
- СДС: (`i = 4`).

Состояние `S_k` активов в портфеле в начале этапа `k` задаётся вектором из четырёх чисел:

`S_k = (S_k^1, S_k^2, S_k^3, S_k^4)`,

где:

- `S_k^1` - стоимость ЦБ1,
- `S_k^2` - стоимость ЦБ2,
- `S_k^3` - стоимость Деп.,
- `S_k^4` - стоимость СДС

(позиции активов в векторе, как было сказано выше, соответствуют их индексам `i = 1, 2, 3, 4`, значения которых также были указаны выше).

Дано состояние портфеля на начало первого этапа:

`S_1 = (100, 800, 400, 600)`

На каждом из трёх этапов `k = 1, 2, 3` совершается операция `x_k` ребалансировки портфеля, которая задаётся вектором из трёх чисел:

`x_k = (x_k^1, x_k^2, x_k^3)`,

где `x_k^i` - количество купленных/проданных пакетов соответствующего актива (`x_k^i > 0` - покупка, `x_k^i < 0` - продажа, `x_k^i = 0` - отсутствие операций купли/продажи).

Стоимость одного пакета для активов задаётся следующим массивом:

`L = [25, 200, 100]`

(позиции значений соответствуют индексам `i = 1, 2, 3` активов).

Соответственно, стоимость актива `i` после применения операции `x_k^i` изменяется на следующую величину:

`Δ_k^i = x_k^i * L[i]` для `i = 1, 2, 3` (торгуемые активы: ЦБ1, ЦБ2, Деп.), где `Δ_k^i` - изменение стоимости актива `i` на этапе `k` после применения операции `x_k^i`.

В результате стоимость торгуемых активов изменяется следующим образом:

`(S_k')^i = S_k^i + Δ_i` для `i = 1, 2, 3`

Также за каждую операцию купли/продажи приходится платить определённую комиссию. Комиссия для активов указаны в следующем массиве:

`c = [0.04, 0.07, 0.05]`

Суммарная стоимость всех операций (с учётом комиссии):

`Cost(x_k) = Σ_{i=1}^{3} (Δ_i + c[i] * |Δ_i|)`

Здесь `|Δ_i|` - абсолютная стоимость операции, на которую начисляется комиссия.

Операции купли/продажи, а также взятие комиссии происходят за счёт СДС, в результате чего сразу после применения операции `x_k` значение СДС `(S_k')^4` равняется:

`(S_k')^4 = S_k^4 - Cost(x_k)`

В результате, после применения операции `x_k` к портфелю с состоянием `S_k` мы получаем портфель с состоянием `S_k'`:

`S_k' = ((S_k')^1, (S_k')^2, (S_k')^3, (S_k')^4)`.

После применения операции `x_k` происходит детерминированное событие `w_k` (переход от вероятных к детерминированным событиям был писан выше), которое задаётся вектором из трёх чисел:

`w_k = (w_k^1, w_k^2, w_k^3)`,

где `w_k^i` - коэффициент изменения стоимости торгуемого актива `i` (на стоимость СДС события `w_k` не влияют).

В результате наступления события `w_k` стоимость актива `i` изменяется следующим образом:

`S_{k+1}^i = (S_k')^i * w_k^i` для `i = 1, 2, 3`,

где `S_{k+1}^i` - стоимость актива `i` после наступления события `w_k`, а также стоимость актива `i` в начале этапа `k+1` (поле наступления события `w_k` происходит переход от этапа `k` к этапу `k+1`).

Соответственно, в рамках события `w_k` происходит переход с этапа `k` к этапу `k+1` и состояние портфеля становится:

`S_{k+1} = (S_{k+1}^1, S_{k+1}^2, S_{k+1}^3, S_{k+1}^4)`,

где `S_{k+1}^4 = (S_k')^4` (стоимость СДС в рамках события `w_k` не изменяется).

Также существует ограничения на минимально допустимую стоимость в любой момент времени для каждого актива. Ограничения задаются следующим массивом:

`S_min = [30, 150, 100, 0]`

(в рамках массива также учитывается, что СДС не может быть отрицательным, т.е. нельзя использовать кредитные средства).

В результате, на стоимость актива `i` действуют следующие ограничения:

- `S_k^i >= S_min[i]`,
- `(S_k')^i >= S_min[i]`,
- `S_{k+1}^i >= S_min[i]`.

Видим, что в рамках задачи имеет место быть следующая последовательность:

`S_k -> x_k -> S_k' -> w_k -> S_{k+1}`

Объединим шаги `x_k -> S_k' -> w_k` в рамках функции перехода состояния `T_k` для этапа `k` и получим:

`S_{k+1} = T_k(S_k, x_k, w_k)`

Целевой функцией `F` назовём суммарную стоимость всех активов в портфеле `sum(S_4)` после третьего этапа:

`F = sum(S_4)`,

где:

`S_4 = (S_4^1, S_4^2, S_4^3, S_4^4)` - состояние портфеля после третьего этапа (т.е. сразу после наступления события `w_3`).

В рамках данной задачи требуется максимизировать значение целевой функции:

`F = sum(S_4) -> max`,

т.е. найти последовательность допустимых управлений `(x_1, x_2, x_3)`, которая максимизирует целевую функцию `F = sum(S_4)` при заданном начальном состоянии `S_1` портфеля и функциях перехода `T_k`.
