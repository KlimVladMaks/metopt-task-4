# Решение задачи динамического программирования

## Ф.И.О., группа, поток

Клименков Владислав Максимович, K3341, МЕТОПТ 1.2

## Предобработка условий задачи

В задании сказано, что покупать и продавать активы можно только пакетами, стоимость которых равна 25% от изначальной стоимости актива. Рассчитаем стоимость одного пакета для каждого актива:

- `ЦБ1: 100 * 25% = 25 (д.е.)`
- `ЦБ2: 800 * 25% = 200 (д.е.)`
- `Деп.: 400 * 25% = 100 (д.е.)`

---

Для каждого этапа для всех трёх активов заданы сценарии с вероятностью их наступления и коэффициентом изменения стоимости актива при реализации данного сценария:

**Этап №1:**

| Ситуация | Вероят. | ЦБ1 | ЦБ2 | Деп. |
|--|--|--|--|--|
| Благопр. | 0,60 | 1,20 | 1,10 | 1,07 |
| Нейтр. | 0,30 | 1,05 | 1,02 | 1,03 |
| Негатив. | 0,10 | 0,80 | 0,95 | 1,00 |

**Этап №2:**

| Ситуация | Вероят. | ЦБ1 | ЦБ2 | Деп. |
|--|--|--|--|--|
| Благопр. | 0,30 | 1,4 | 1,15 | 1,01 |
| Нейтр. | 0,20 | 1,05 | 1,00 | 1,00 |
| Негатив. | 0,50 | 0,60 | 0,90 | 1,00 |

**Этап №3:**

| Ситуация | Вероят. | ЦБ1 | ЦБ2 | Деп. |
|--|--|--|--|--|
| Благопр. | 0,40 | 1,15 | 1,12 | 1,05 |
| Нейтр. | 0,40 | 1,05 | 1,01 | 1,01 |
| Негатив. | 0,20 | 0,70 | 0,94 | 1,00 |

Чтобы упростить задачу, уйдём от вероятностей, перейдя к ожидаемому изменению стоимости для каждого актива (т.е. объединим три сценария и их вероятности в одно значение ожидаемого изменения стоимости актива). Для этого воспользуемся формулой математического ожидания, которая имеет следующий вид:

`E(X) = Σ [x_i * p_i]`

где:

- `x_i` - возможные значения случайной величины,
- `p_i` - их вероятности.

Используя эту формулу, рассчитаем для каждого этапа ожидаемые значения изменения стоимости для каждого актива:

**Этап №1:**

- `ЦБ1: (0,60 * 1,20) + (0,30 * 1,05) + (0,10 * 0,80) = 1,115`
- `ЦБ2: (0,60 * 1,10) + (0,30 * 1,02) + (0,10 * 0,95) = 1,061`
- `Деп.: (0,60 * 1,07) + (0,30 * 1,03) + (0,10 * 1,00) = 1,051`

**Этап №2:**

- `ЦБ1: (0,30 * 1,40) + (0,20 * 1,05) + (0,50 * 0,60) = 0,93`
- `ЦБ2: (0,30 * 1,15) + (0,20 * 1,00) + (0,50 * 0,90) = 0,995`
- `Деп.: (0,30 * 1,01) + (0,20 * 1,00) + (0,50 * 1,00) = 1,003`

**Этап №3:**

- `ЦБ1: (0,40 * 1,15) + (0,40 * 1,05) + (0,20 * 0,70) = 1,02`
- `ЦБ2: (0,40 * 1,12) + (0,40 * 1,01) + (0,20 * 0,94) = 1,04`
- `Деп.: (0,40 * 1,05) + (0,40 * 1,01) + (0,20 * 1,00) = 1,024`

Запишем полученные результаты в виде таблицы:

| Этап | ЦБ1 | ЦБ2 | Деп. |
|--|--|--|--|
| 1 | 1,115 | 1,061 | 1,051 |
| 2 | 0,93 | 0,995 | 1,003 |
| 3 | 1,02 | 1,04 | 1,024 |

Теперь данный аспект задачи стал существенно проще.

## Архив 1

- `T = 3` - количество этапов управления.

- `k = 1, 2, 3` - этапы управления (`k = 1` - первый этап, `k = 3` - последний этап).

- `L = [25, 200, 100]` - размеры пакетов (лоты) для активов: ЦБ1, ЦБ2, Деп.

- `c = [0.04, 0.07, 0.05]` - комиссионные ставки для операций с ЦБ1, ЦБ2, Деп.

- `w_k` - коэффициенты изменения стоимости активов ЦБ1, ЦБ2, Деп. на этапе `k` (СДС не изменяется).
    - `w_1 = (1.115, 1.061, 1.051)`
    - `w_2 = (0.93, 0.995, 1.003)`
    - `w_3 = (1.02, 1.04, 1.024)`

- `S_min = [30, 150, 100, 0]` - минимально допустимая стоимость активов ЦБ1, ЦБ2, Деп., СДС (СДС не может быть отрицательным).

- `S_1 = [100, 800, 400, 600]` - стоимость активов ЦБ1, ЦБ2, Деп, СДС в начале первого этапа.

- `S_k = (s_k^1, s_k^2, s_k^3, s_k^4)` - стоимость активов в начале этапа `k`, где:
    - `s_k^1` — стоимость ЦБ1.
    - `s_k^2` — стоимость ЦБ2.
    - `s_k^3` — стоимость Деп.
    - `s_k^4` — стоимость СДС.

`x_k = (x_k^1, x_k^2, x_k^3)` - управление портфелем на этапе `k`, где `x_k^i` - количество покупаемых/продаваемых (положительное - покупка, отрицательное - продажа) пакетов активов ЦБ1, ЦБ2, Деп.

- Целевая функция: Максимизировать общую стоимость портфеля в конце горизонта планирования: `F = S_4 -> max`.

## Архив 2

В рамках векторов и массивов активы имеют следующие индексы:

- `ЦБ1: i = 1`,
- `ЦБ2: i = 2`,
- `Деп.: i = 3`,
- `СДС: i = 4` (свободные денежные средства).

---

`k = 1, 2, 3` - этапы, на которых доступно управление портфелем (`k = 1` - первый этап, `k = 3` - последний этап).

---

`L = [25, 200, 100]` - размеры пакетов (лоты) для активов: ЦБ1, ЦБ2, Деп.

---

`c = [0.04, 0.07, 0.05]` - комиссии для операций с ЦБ1, ЦБ2, Деп.

---

`w_k` - коэффициенты изменения стоимости активов ЦБ1, ЦБ2, Деп. на этапе `k` (СДС не изменяется).
- `w_1 = (1.115, 1.061, 1.051)`
- `w_2 = (0.93, 0.995, 1.003)`
- `w_3 = (1.02, 1.04, 1.024)`

---

`S_min = [30, 150, 100, 0]` - минимально допустимая стоимость активов ЦБ1, ЦБ2, Деп., СДС (СДС не может быть отрицательным).

---

`S_1 = [100, 800, 400, 600]` - стоимость активов ЦБ1, ЦБ2, Деп, СДС в начале первого этапа.

---

`S_k = (S_k_1, S_k_2, S_k_3, S_k_4)` - стоимость активов в начале этапа `k`, где:
- `S_k_1` - стоимость ЦБ1.
- `S_k_2` - стоимость ЦБ2.
- `S_k_3` - стоимость Деп.
- `S_k_4` - стоимость СДС.

---

`x_k = (x_k_1, x_k_2, x_k_3)` - управление портфелем на этапе `k`, где `x_k^i` - количество покупаемых/продаваемых (положительное - покупка, отрицательное - продажа) пакетов активов ЦБ1, ЦБ2, Деп.

---

Имеем следующую последовательность:

`S_k -> x_k -> w_k -> S_{k+1}`

То есть сначала смотрим состояние портфеля `S_k` на начало этапа, потом совершаем операцию `x_k` по ребалансировке активов (сюда же входить и взятие комиссии с операций купли/продажи), потом происходит событие `w_k` изменения стоимости активов, в результате которого мы переходим к новому состоянию портфеля `S_{k+1}` в начале следующего этапа и т.д.

---

В рамках задачи требуется максимизировать общую стоимость портфеля в конце горизонта планирования.

Целевая функция:

`F = S_4 -> max`.

---

Функция перехода состояний `T_k` для этапа `k`:

`S_{k+1} = T_k(S_k, x_k, w_k)`

Эта функция описывает, как состояние `S_k` при операции `x_k` и событии `w_k` переходит к новому состоянию `S_{k+1}`.

Изменение стоимости актива после покупки/продажи:

`Δ_i = x_k_i * L[i]` для `i = 1, 2, 3`

Суммарная стоимость всех операций (с учётом комиссии):

`Cost(x_k) = Σ_{i=1}^{3} (Δ_i + c[i] * |Δ_i|)`

Здесь `|Δ_i|` - абсолютная стоимость операции, на которую начисляется комиссия.

`S_k'` - состояние активов сразу после операции `x_k`, но до наступления события `w_k`.

Новые промежуточные состояния:
- Для торгуемых активов (`i = 1, 2, 3`): `s_k_i' = s_k_i + Δ_i`
- Для СДС (`i = 4`): `s_k_4' = s_k_4 - Cost(x_k)`

Также даны следующие ограничения:

`s_k_i' >= S_min[i]` для `i = 1, 2, 3, 4`

В результате события `w_k` стоимости активов умножаются на соответствующие коэффициенты (кроме СДС, стоимость которой остаётся постоянной):
- `s_{k+1}_i = s_k_i' * w_k_i` для `i = 1, 2, 3`
- `s_{k+1}_4 = s_k_4'` для `i = 4` (Стоимость СДС остаётся постоянной)

При этом, для результат события также должно выполняться условие:

`s_{k+1}_i' >= S_min[i]` для `i = 1, 2, 3`

---

Задача динамического программирования:

Требуется найти последовательность допустимых управлений `(x_1, x_2, x_3)`, которая максимизирует целевую функцию `F` при заданных начальном состоянии `S_1` и функциях перехода `T_k`.

## Общая математическая формулировка задачи динамического программирования
