# Решение задачи динамического программирования

## Ф.И.О., группа, поток

Клименков Владислав Максимович, K3341, МЕТОПТ 1.2

## Предобработка условий задачи

### Расчёт стоимости пакетов для покупки/продажи активов

В задании сказано, что покупать и продавать активы можно только пакетами, стоимость которых равна 25% от изначальной стоимости актива. Рассчитаем стоимость одного пакета для каждого актива:

- `ЦБ1: 100 * 25% = 25 (д.е.)`
- `ЦБ2: 800 * 25% = 200 (д.е.)`
- `Деп.: 400 * 25% = 100 (д.е.)`

В дальнейшем будем использовать уже рассчитанные значения стоимости пакетов.

## Описание задачи

У нас есть инвестиционный портфель, которым мы будем управлять на протяжении трёх этапов `k = 1`, `k = 2` и `k = 3`, где `k = 1` - первый этап, а `k = 3` - последний этап.

На начало каждого этапа нам известно состояние инвестиционного портфеля `S_k`. Сам портфель может содержать четыре актива (в скобках указаны сокращения названий активов, а также индексы `i`, которые данные активы занимают в векторах и массивах):

- Ценная бумага 1 (`ЦБ1: i = 1`)
- Ценная бумага 2 (`ЦБ2: i = 2`)
- Депозиты (`Деп.: i = 3`)
- Свободные денежные средства (`СДС: i = 4`)

Стоимость активов измеряется в денежных единицах (д.е.).

Изначально в инвестиционном портфеле следующее распределение активов:

- `ЦБ1 = 100 д.е.`
- `ЦБ2 = 800 д.е.`
- `Деп. = 400 д.е.`
- `СДС = 600 д.е.`

Состояние `S_k` задаётся вектором из четырёх чисел, соответствующих стоимости активов в портфеле по принципу `S_k = (<стоимость ЦБ1>, <стоимость ЦБ2>, <стоимость Деп.>, <стоимость СДС>)`.  Соответственно, для первого этапа мы имеем `S_1 = (100, 800, 400, 600)`.

Также на каждом этапе мы можем совершить операцию `x_k` по разбалансировке (покупке и продаже) активов. Покупать и продавать активы можно только пакетами (лотами). Вот размеры пакетов для каждого актива:

-  `1 пакет ЦБ1 = 25 д.е.`
-  `1 пакет ЦБ2 = 200 д.е.`
-  `1 пакет Деп. = 100 д.е.`

Для каждого этапа операция записывается в формате вектора из трёх чисел, где каждое число соответствует числу покупаемых или продаваемых пакетов активов `x_k = (<количество купленных/проданных пакетов ЦБ1>, <количество купленных/проданных пакетов ЦБ2>, <количество купленных/проданных пакетов Деп.>)`. Например, если на первом этапе мы хотим купить два пакета ЦБ1 (на 50 д.е.) и продать один пакет Деп. (100 д.е.), не трогая ЦБ2, то это можно записать как `x_1 = (2, 0, -1)`.

Также нужно учитывать, что по условиям задачи за каждую операцию берётся комиссия. Вот какие комиссии для операций с активами:

-  `ЦБ1: 4%`
-  `ЦБ2: 7%`
-  `Деп.: 5%`

То есть, например, при покупке или продаже одного пакета Деп. стоимостью 100 д.е. придётся заплатить комиссию в 5%, в данном случае равную 5 д.е.

Все покупки активов и комиссии по операциям оплачиваются из СДС. Например, при покупке `n` пакетов актива со стоимостью пакета `C` и комиссией `p` суммарные затраты из СДС составят `n * C * (1 + p)`. При продаже `n` пакетов в СДС поступает `n * C * (1 - p)`.

После совершения операций `x_k` наступает стохастическое событие `w_k` (в данном случае под событием подразумевается полное вероятностное пространство) для соответствующего этапа `k`. В рамках события `w_k` может реализоваться один из трёх сценариев `w_{k,t}`, где `t` - реализовавшийся сценарий: позитивный сценарий (`t = 1`) `w_{k,1}`, нейтральный сценарий (`t = 2`) `w_{k,2}` или негативный сценарий (`t = 3`) `w_{k,3}`. Ниже представлены таблицы с описанием событий `w_k` для всех трёх этапов. В таблицах указаны вероятности наступления того или иного сценария, а также коэффициент изменения стоимости актива при реализации данного сценария:

**Этап №1:**

| Ситуация | Вероят. | ЦБ1 | ЦБ2 | Деп. |
|--|--|--|--|--|
| Благопр. | 0.60 | 1.20 | 1.10 | 1.07 |
| Нейтр. | 0.30 | 1.05 | 1.02 | 1.03 |
| Негатив. | 0.10 | 0.80 | 0.95 | 1.00 |

**Этап №2:**

| Ситуация | Вероят. | ЦБ1 | ЦБ2 | Деп. |
|--|--|--|--|--|
| Благопр. | 0.30 | 1.4 | 1.15 | 1.01 |
| Нейтр. | 0.20 | 1.05 | 1.00 | 1.00 |
| Негатив. | 0.50 | 0.60 | 0.90 | 1.00 |

**Этап №3:**

| Ситуация | Вероят. | ЦБ1 | ЦБ2 | Деп. |
|--|--|--|--|--|
| Благопр. | 0.40 | 1.15 | 1.12 | 1.05 |
| Нейтр. | 0.40 | 1.05 | 1.01 | 1.01 |
| Негатив. | 0.20 | 0.70 | 0.94 | 1.00 |

То есть, например, если на втором этапе реализуется негативный сценарий (это произойдёт с вероятностью 0.50), то стоимость ЦБ2 будет домножена на коэффициент 0.90 (т.е. стоимость ЦБ2 снизится на 10%), если же на этом же этапе реализуется благоприятный сценарий (это произойдёт с вероятностью 0.30), то стоимость ЦБ2 будет домножена на коэффициент 1.15 (т.е. стоимость ЦБ2 вырастет на 15%). Аналогично и для других этапов, сценариев и активов.

Событие `w_k` можно представить в виде вектора из трёх сценариев `t = 1, 2, 3`:

`w_k = (w_{k,1}, w_{k,2}, w_{k,3})`,

где `w_{k,t}` - конкретный сценарий.

Каждый сценарий `w_{k,t}` задаётся вектором из трёх коэффициентов изменения стоимости активов ЦБ1, ЦБ2 и Деп. соответственно:

`w_{k,t} = (w_{k,t}^1, w_{k,t}^2, w_{k,t}^3)`,

где `w_{k,t}^i` - коэффициент изменения стоимости соответствующего актива `i` (см. соответствие индексов `i = 1, 2, 3, 4` активам, указанное выше).

Стоимость СДС не изменяется в рамках события `w_k`, а потому для него не указывается коэффициент изменения стоимости.

Например, нейтральный сценарий второго этапа можно записать следующим образом:

`w_{2,2} = (1.05, 1.01, 1.01)`

Вероятность конкретного сценария задаётся функцией вероятности `P_k`:

`P_k(t) = p_{k,t}`,

где `p_{k,t}` - вероятность наступления сценария `t` на этапе `k`.

Например, для нейтрального сценария `t = 2` первого этапа `k = 1` имеем:

`P_1(2) = p_{1,2} = 0.30`

В результате мы получаем следующую последовательность:

`S_k -> x_k -> w_k -> S_{k+1}`

То есть сначала мы смотрим состояние на данном этапе, потом совершаем операции на данном этапе, потом происходит событие на данном этапе, после чего мы смотрим состояние уже на следующем этапе.

Также по заданию существуют ограничения, которые задают минимальную стоимость каждого актива в портфеле:

- `ЦБ1: Не менее 30 д.е.`
- `ЦБ2: Не менее 150 д.е.`
- `Деп.: Не менее 100 д.е.`
- `СДС: Не менее 0 д.е.` (СДС не может быть отрицательным)

То есть, например, в любой момент стоимость ЦБ2 в портфеле не может опускаться ниже 150 д.е. (нельзя продать, чтобы стоимость стала меньше, и нельзя допустить, чтобы в рамках события стоимость ЦБ2 опустилась ниже данного значения). Аналогично и для других активов.

## Цель задачи

Требуется разработать такой план управления покупками/продажами активов на этапах `k = 1, 2, 3`, чтобы максимизировать общую стоимость инвестиционного портфеля в конце третьего этапа (`S_4`).

## Математическая постановка задачи

В рамках задачи рассматриваются три этапа `k = 1, 2, 3` управления инвестиционным портфелем, который содержит следующие активы (в скобках указаны индексы данных активов, согласно которым они будут располагаться в рамках массивов и векторов):

- ЦБ1 (`i = 1`),
- ЦБ2: (`i = 2`),
- Деп.: (`i = 3`),
- СДС: (`i = 4`).

Состояние `S_k` активов в портфеле в начале этапа `k` задаётся вектором из четырёх чисел:

`S_k = (S_k^1, S_k^2, S_k^3, S_k^4)`,

где:

- `S_k^1` - стоимость ЦБ1,
- `S_k^2` - стоимость ЦБ2,
- `S_k^3` - стоимость Деп.,
- `S_k^4` - стоимость СДС

(позиции активов в векторе, как было сказано выше, соответствуют их индексам `i = 1, 2, 3, 4`, значения которых также были указаны выше).

Дано состояние портфеля на начало первого этапа:

`S_1 = (100, 800, 400, 600)`

На каждом из трёх этапов `k = 1, 2, 3` совершается операция `x_k` ребалансировки портфеля, которая задаётся вектором из трёх чисел:

`x_k = (x_k^1, x_k^2, x_k^3)`,

где `x_k^i` - количество купленных/проданных пакетов соответствующего актива (`x_k^i > 0` - покупка, `x_k^i < 0` - продажа, `x_k^i = 0` - отсутствие операций купли/продажи).

Стоимость одного пакета для активов задаётся следующим массивом:

`L = [25, 200, 100]`

(позиции значений соответствуют индексам `i = 1, 2, 3` активов).

Соответственно, стоимость актива `i` после применения операции `x_k^i` изменяется на следующую величину:

`Δ_k^i = x_k^i * L[i]` для `i = 1, 2, 3` (торгуемые активы: ЦБ1, ЦБ2, Деп.), где `Δ_k^i` - изменение стоимости актива `i` на этапе `k` после применения операции `x_k^i`.

В результате стоимость торгуемых активов изменяется следующим образом:

`(S_k')^i = S_k^i + Δ_i` для `i = 1, 2, 3`

Также за каждую операцию купли/продажи приходится платить определённую комиссию. Комиссия для активов указаны в следующем массиве:

`c = [0.04, 0.07, 0.05]`

Суммарная стоимость всех операций (с учётом комиссии):

`Cost(x_k) = Σ_{i=1}^{3} (Δ_i + c[i] * |Δ_i|)`

Здесь `|Δ_i|` - абсолютная стоимость операции, на которую начисляется комиссия.

Операции купли/продажи, а также взятие комиссии происходят за счёт СДС, в результате чего сразу после применения операции `x_k` значение СДС `(S_k')^4` равняется:

`(S_k')^4 = S_k^4 - Cost(x_k)`

В результате, после применения операции `x_k` к портфелю с состоянием `S_k` мы получаем портфель с состоянием `S_k'`:

`S_k' = ((S_k')^1, (S_k')^2, (S_k')^3, (S_k')^4)`.

После применения операции `x_k` происходит стохастическое событие `w_k` (в данном случае под событием подразумевается полное вероятностное пространство), которое содержит три возможных сценария `w_{k,t}`:

- `w_{k,1}` - позитивный сценарий (`t = 1`),
- `w_{k,2}` - нейтральный сценарий (`t = 2`),
- `w_{k,3}` - негативный сценарий (`t = 3`),

Соответственно, событие `w_k` задаётся вектором из трёх данных сценариев `w_{k,t}` с `t = 1, 2, 3`:

`w_k = (w_{k,1}, w_{k,2}, w_{k,3})`

В свою очередь, каждый сценарий `w_{k,t}` задаётся вектором из трёх коэффициентов изменения стоимости активов ЦБ1, ЦБ2 и Деп. соответственно:

`w_{k,t} = (w_{k,t}^1, w_{k,t}^2, w_{k,t}^3)`,

где `w_{k,t}^i` - коэффициент изменения стоимости соответствующего актива `i` (стоимость СДС не изменяется в рамках события `w_k`, а потому для него не указывается коэффициент изменения стоимости).

Вероятность конкретного сценария задаётся функцией вероятности `P_k`:

`P_k(t) = p_{k,t}`,

где `p_{k,t}` - вероятность наступления сценария `t` на этапе `k`.

По условиям задачи, для всех сценариев на всех трёх этапах нам известны их вероятности и коэффициенты изменения стоимости активов:

**Вероятности реализации сценариев:**

- Этап 1:
    - `p_{1,1} = 0.60`
    - `p_{1,2} = 0.30`
    - `p_{1,3} = 0.10`

- Этап 2:
    - `p_{2,1} = 0.30`
    - `p_{2,2} = 0.20`
    - `p_{2,3} = 0.50`

- Этап 3:
    - `p_{3,1} = 0.40`
    - `p_{3,2} = 0.40`
    - `p_{3,3} = 0.20`

**Коэффициенты изменения стоимости активов:**

- Этап 1:
    - `w_{1,1} = (1.20, 1.10, 1.07)`
    - `w_{1,2} = (1.05, 1.02, 1.03)`
    - `w_{1,3} = (0.80, 0.95, 1.00)`

- Этап 2:
    - `w_{2,1} = (1.4, 1.15, 1.01)`
    - `w_{2,2} = (1.05, 1.00, 1.00)`
    - `w_{2,3} = (0.60, 0.90, 1.00)`

- Этап 3:
    - `w_{3,1} = (1.15, 1.12, 1.05)`
    - `w_{3,2} = (1.05, 1.01, 1.01)`
    - `w_{3,3} = (0.70, 0.94, 1.00)`

В результате наступления сценария `w_{k,t}` стоимость актива `i` изменяется следующим образом:

`S_{k+1}^i = (S_k')^i * w_{k,t}^i` для `i = 1, 2, 3`,

где `S_{k+1}^i` - стоимость актива `i` после реализации сценария `w_{k,t}`, а также стоимость актива `i` в начале этапа `k+1` (поле реализации сценария `w_{k,t}` происходит переход от этапа `k` к этапу `k+1`).

Соответственно, в рамках сценария `w_{k,t}` происходит переход с этапа `k` к этапу `k+1` и состояние портфеля становится:

`S_{k+1} = (S_{k+1}^1, S_{k+1}^2, S_{k+1}^3, S_{k+1}^4)`,

где `S_{k+1}^4 = (S_k')^4` (стоимость СДС в рамках сценария `w_{k,t}` не изменяется).
